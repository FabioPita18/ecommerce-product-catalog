# Nginx Configuration for React SPA
#
# Key configuration:
# 1. try_files: Falls back to index.html for client-side routing
#    (React Router handles the URL, not Nginx)
# 2. API proxy: Forwards /api requests to the Django backend service
# 3. Gzip: Compresses text-based assets for faster downloads
# 4. Static caching: Long cache for hashed assets (Vite adds content hashes)
#
# Environment variables (substituted at container startup via envsubst):
#   - PORT: The port Nginx listens on (Railway injects this)
#   - BACKEND_URL: The backend service public URL (e.g., https://backend-xxx.up.railway.app)

# Use public DNS resolvers (NOT 127.0.0.11 which is unavailable on Railway)
resolver 8.8.8.8 1.1.1.1 valid=30s ipv6=off;

server {
    listen ${PORT};
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Enable gzip compression for text-based assets
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Handle SPA routing - all non-file URLs serve index.html
    # React Router then reads the URL and renders the correct page
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Proxy API requests to the Django backend service
    # Using a variable forces Nginx to re-resolve DNS per request,
    # preventing stale IP caching when the backend redeploys
    location /api {
        set $upstream ${BACKEND_URL};
        proxy_pass $upstream;

        # Required for HTTPS upstream (SNI - Server Name Indication)
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;

        # Host header MUST be the backend domain for Railway's edge routing
        proxy_set_header Host ${BACKEND_HOST};
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # Cache static assets with content hashes for 1 year
    # Vite generates filenames like index-CFvylqeK.js with content hashes,
    # so the filename changes when the content changes (cache busting)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
